<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">운동영상 리뷰</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>

<div class="container">
    <div class="header">
        <h2 id="videoTitle">운동영상 리뷰</h2>
    </div>

    <div class="video-container">
        <iframe id="videoPlayer" src="" frameborder="0" allowfullscreen></iframe>
        <select id="videoSelect">
            <!-- 비디오 옵션이 여기서 동적으로 채워집니다 -->
        </select>
    </div>

    <div class="review-section">
        <button id="openModalBtn"class="btn">리뷰 작성</button>
        <a href="review_management.html" class="btn">리뷰 관리</a>

        <table>
            <thead>
                <tr>
                    <th>제목</th>
                    <th>내용</th>
                    <th>날짜</th>
                    <th>비디오</th>
                </tr>
            </thead>
            <tbody id="reviewList">
                <!-- 리뷰 목록이 여기에 동적으로 채워집니다 -->
            </tbody>
        </table>

        <div class="pagination">
            <button>&laquo;</button>
            <button>1</button>
            <button>&raquo;</button>
        </div>
    </div>
</div>

<!-- The Modal -->
<div id="myModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>리뷰 작성</h2>
    </div>
    <div class="modal-body">
      <label for="title">제목</label>
      <input type="text" id="title" name="title">

      <label for="content">내용</label>
      <textarea id="content" name="content" rows="4"></textarea>
    </div>
    <div class="modal-footer">
      <button class="submit-btn" id="submitReview">등록</button>
      <button class="cancel-btn" id="closeModalBtn">취소</button>
    </div>
  </div>
</div>

<script>
// 서버에서 리뷰 데이터를 가져와서 테이블에 추가하는 함수
async function loadReviews() {
    try {
        const response = await fetch('/reviews');
        const reviews = await response.json();
        const reviewList = document.getElementById('reviewList');

        reviews.forEach(review => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${review.title}</td>
                <td>${review.content}</td>
                <td>${review.date}</td>
                <td>${review.videoTitle}</td>
            `;
            reviewList.appendChild(row);
        });
    } catch (error) {
        console.error('리뷰를 불러오는 중 오류가 발생했습니다:', error);
    }
}

// 리뷰를 서버에 저장하는 함수
async function saveReview(review) {
    try {
        const response = await fetch('/reviews', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(review)
        });

        if (response.ok) {
            console.log('리뷰가 성공적으로 저장되었습니다.');
        } else {
            console.error('리뷰 저장에 실패했습니다.');
        }
    } catch (error) {
        console.error('리뷰 저장 중 오류가 발생했습니다:', error);
    }
}

// 비디오 선택 박스를 채우는 함수
async function loadVideos() {
    try {
        const response = await fetch('/video.json');
        const videos = await response.json();
        const videoSelect = document.getElementById('videoSelect');
        const videoTitle = document.getElementById('videoTitle');
        const pageTitle = document.getElementById('pageTitle');
        const videoPlayer = document.getElementById('videoPlayer');

        videos.forEach(video => {
            const option = document.createElement('option');
            option.value = video.url;
            option.text = video.title;
            videoSelect.appendChild(option);
        });

        videoSelect.onchange = function() {
            const selectedTitle = this.options[this.selectedIndex].text;
            videoPlayer.src = this.value;
            videoTitle.textContent = selectedTitle;
            pageTitle.textContent = selectedTitle;
        };

        // 첫 번째 비디오를 기본으로 설정
        videoSelect.selectedIndex = 0;
        videoSelect.onchange();
    } catch (error) {
        console.error('비디오 목록을 불러오는 중 오류가 발생했습니다:', error);
    }
}

document.getElementById('submitReview').onclick = async function() {
    const title = document.getElementById('title').value;
    const content = document.getElementById('content').value;
    const date = new Date().toLocaleString();
    const videoTitle = document.getElementById('videoSelect').selectedOptions[0].text;

    const newReview = { title, content, date, videoTitle };

    // 서버에 리뷰 저장
    await saveReview(newReview);

    // 새 리뷰를 테이블에 추가
    const reviewList = document.getElementById('reviewList');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${title}</td>
        <td>${content}</td>
        <td>${date}</td>
        <td>${videoTitle}</td>
    `;
    reviewList.appendChild(row);

    // 입력 필드 초기화
    document.getElementById('title').value = '';
    document.getElementById('content').value = '';

    // 모달 닫기
    document.getElementById('myModal').style.display = 'none';
};

document.getElementById('closeModalBtn').onclick = function() {
    document.getElementById('myModal').style.display = 'none';
};

// 페이지 로드 시 기존 리뷰와 비디오 목록을 서버에서 가져옴
window.onload = function() {
    loadReviews();
    loadVideos();
};

// 모달 외부 클릭 시 모달 닫기
window.onclick = function(event) {
    if (event.target == document.getElementById('myModal')) {
        document.getElementById('myModal').style.display = 'none';
    }
};

// 모달 열기
document.getElementById('openModalBtn').onclick = function() {
    document.getElementById('myModal').style.display = 'block';
};
</script>

</body>
</html>
